<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />

    <link rel="stylesheet" href="CSS/main.css" />
    <link rel="stylesheet" href="CSS/fireflies.css" />
    <link rel="stylesheet" href="CSS/visualizer.css" />
    <link rel="stylesheet" href="CSS/backjack.css"/>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Tiny5&display=swap"
      rel="stylesheet"
    />

    <title>Chroma</title>

    <style>
      /* Menu Overlay Styles */
      .menu-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(10px);
        z-index: 1000; display: flex; flex-direction: column;
        justify-content: center; align-items: center;
        opacity: 0; pointer-events: none; transition: opacity 0.4s ease;
      }
      .menu-overlay.active { opacity: 1; pointer-events: all; }
      .menu-items { list-style: none; text-align: center; padding: 0; }
      .menu-items li { margin: 20px 0; }
      .menu-items a {
        font-family: "Tiny5", cursive; font-size: 3rem; color: white;
        text-decoration: none; text-transform: uppercase; letter-spacing: 2px;
        transition: color 0.3s ease, text-shadow 0.3s ease;
      }
      .menu-items a:hover { color: #00ffcc; text-shadow: 0 0 10px #00ffcc, 0 0 20px #00ffcc; }
      .close-btn {
        position: absolute; top: 30px; right: 40px;
        font-family: "Tiny5", cursive; font-size: 2rem; color: white;
        cursor: pointer; transition: transform 0.3s ease;
      }
      .close-btn:hover { transform: scale(1.2); color: #ff0055; }
      .btn-menu { cursor: pointer; z-index: 1001; }
    </style>
  </head>
  <body>
    <div class="background"></div>
    <canvas id="fireflies"></canvas>
    <canvas id="scary-fireflies"></canvas>

    <div class="ui-layer">
      <div class="menu-overlay" id="menuOverlay">
        <div class="close-btn" id="closeMenuBtn">X</div>
        <ul class="menu-items">
          <li><a href="#">Home</a></li>
          <li><a href="#">Profile</a></li>
          <li><a href="#" id="uploadLink">Upload Video</a></li>
          <li><a href="#">Live Video</a></li>
          <li><a href="loginpage.html">Log Out</a></li>
        </ul>
        <input type="file" id="videoInput" accept="video/*" style="display: none" />
        <p id="uploadStatus" style="color: white; text-align: center; margin-top: 10px"></p>
      </div>

      <div class="header" id="mainHeader">
        <div class="btn-menu" id="menuTrigger">menu</div>
        <div class="btn-login"><a href="loginpage.html">Wallet</a></div>
      </div>

      <div class="header-box" id="mainHeadingBox" style="margin-bottom: 10px">
        <p class="heading">CHROMA</p>
      </div>

      <div class="main-content waiting-to-start" id="mainContent">
        
        <div id="overlay">
            <span>START</span>
            <p>[ CLICK TO REVEAL ]</p>
        </div>

        <div class="first-row">
            
            <div class="left-section">
              <div class="visualizer-container">
                <video id="webcam" autoplay playsinline muted></video>
                <canvas id="visualizer" width="600" height="600"></canvas>
              </div>

              <button id="endBtn" class="pixel-btn" style="margin-top: -80px; z-index: 5;">END SESSION</button>
            </div>

            <div class="workspace">
                <div id="blackjack-game">
                    
                    <div class="hud-score top-left">DEALER: <span id="dealer-score"></span></div>
                    <div class="hud-score top-right">PLAYER: <span id="player-score"></span></div>

                    <div class="hand-section">
                        <div class="cards-container" id="dealer-cards">
                            </div>
                    </div>

                    <div id="game-message">PRESS DEAL TO START</div>

                    <div class="hand-section">
                        <div class="cards-container" id="player-cards">
                            </div>
                    </div>

                    <div class="controls">
                        <button id="btn-hit" class="game-btn" disabled>HIT</button>
                        <button id="btn-stand" class="game-btn" disabled>STAND</button>
                        <button id="btn-deal" class="game-btn">DEAL</button>
                    </div>
                </div>
            </div>
          </div>
        </div>

        <div class="second-row hidden">
            <div class="spinner" id="loadingSpinner"></div>
            <p class="calibration-text">SYSTEM CALIBRATING...</p>
        </div>

        <audio id="audio" src="audio/edm.mp3" crossorigin="anonymous" loop></audio>
      </div>
    </div>

    <script src="JS/Innerfirefiles.js"></script>
    <script src="JS/Outerfireflies.js"></script>
    <script src="JS/visualizer.js"></script>
    <script src="JS/blackjack.js"></script>
    <script src="JS/colorsMl.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const overlay = document.getElementById("overlay");
        const mainContent = document.getElementById("mainContent");
        const audio = document.getElementById("audio");
        const visualizerContainer = document.querySelector(".visualizer-container");
        
        const mainHeader = document.getElementById("mainHeader");
        const mainHeadingBox = document.getElementById("mainHeadingBox");
        const endBtn = document.getElementById("endBtn");
        const textBottom = document.querySelector(".second-row");

        // --- START ---
        overlay.addEventListener("click", () => {
          overlay.style.opacity = "0";
          overlay.style.pointerEvents = "none";

          mainContent.classList.remove("waiting-to-start");
          if(visualizerContainer) visualizerContainer.style.opacity = "1";

          if (audio) audio.play().catch(e => console.log("Audio error:", e));

          if(mainHeader) mainHeader.classList.add("hidden");
          if(mainHeadingBox) mainHeadingBox.classList.add("hidden");
          textBottom.classList.remove("hidden");
        });

        // --- END ---
        endBtn.addEventListener("click", () => {
          if (audio) {
            audio.pause();
            audio.currentTime = 0;
          }

          overlay.style.opacity = "1";
          overlay.style.pointerEvents = "all";

          mainContent.classList.add("waiting-to-start");
          if(visualizerContainer) visualizerContainer.style.opacity = "0";

          if(mainHeader) mainHeader.classList.remove("hidden");
          if(mainHeadingBox) mainHeadingBox.classList.remove("hidden");
          textBottom.classList.toggle("hidden");
        });

        // --- MENU & UPLOAD LOGIC ---
        const menuTrigger = document.getElementById("menuTrigger");
        const menuOverlay = document.getElementById("menuOverlay");
        const closeMenuBtn = document.getElementById("closeMenuBtn");
        const uploadLink = document.getElementById("uploadLink");
        const videoInput = document.getElementById("videoInput");
        const statusText = document.getElementById("uploadStatus");

        menuTrigger.addEventListener("click", () => menuOverlay.classList.add("active"));
        closeMenuBtn.addEventListener("click", () => menuOverlay.classList.remove("active"));
        menuOverlay.addEventListener("click", (e) => {
          if (e.target === menuOverlay) menuOverlay.classList.remove("active");
        });
        
        if (uploadLink) {
          uploadLink.addEventListener("click", (e) => {
            e.preventDefault();
            const menuOverlay = document.getElementById("menuOverlay");
            if (menuOverlay) menuOverlay.classList.remove("active");
            videoInput.click();
          });
        }

        if (videoInput) {
          videoInput.addEventListener("change", function () {
            if (this.files && this.files[0]) validateAndUpload(this.files[0]);
          });
        }

        function validateAndUpload(file) {
          const videoElement = document.createElement("video");
          videoElement.preload = "metadata";
          videoElement.onloadedmetadata = function () {
            window.URL.revokeObjectURL(videoElement.src);
            if (videoElement.duration > 9) {
              alert("Video too long. Max 9s.");
              videoInput.value = "";
              return;
            }
            uploadToBackend(file);
          };
          videoElement.src = URL.createObjectURL(file);
        }

        async function uploadToBackend(file) {
          statusText.innerText = "Uploading...";
          // backend logic...
        }
      });
    </script>
  </body>
</html>